name: Container

on:
  workflow_run:
    workflows: [Verify Codebase]
    types: [completed]

jobs:
  op:
    name: HAL On Premise
    runs-on: ubuntu-latest
    env:
      MVN: ./mvnw --show-version --batch-mode --no-transfer-progress
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: 11
          distribution: temurin
          cache: maven
      - run: $MVN install --projects org.jboss.hal:hal-op --also-make -DskipTests -P op,prod,pfj-snapshot
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  container:
    name: Container
    runs-on: ubuntu-latest
    needs: op
    env:
      MVN: ./mvnw --show-version --batch-mode --no-transfer-progress
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: temurin
          cache: maven
      - run: $MVN install --projects org.jboss.hal:hal-op-standalone -DskipTests -P op,prod
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - uses: redhat-actions/podman-login@v1
        with:
          registry: quay.io
          username: ${{ secrets.QUAY_USERNAME }}
          password: ${{ secrets.QUAY_ROBOT_TOKEN }}
      - name: Build image
        id: build-image
        uses: redhat-actions/buildah-build@v2
        with:
          tags: quay.io/halconsole/halop:latest
          containerfiles: op/standalone/src/main/docker/Dockerfile.native-micro
          context: op/standalone
      - uses: redhat-actions/push-to-registry@v2
        with:
          tags: ${{ steps.build-image.outputs.tags }}
          username: ${{ secrets.QUAY_USERNAME }}
          password: ${{ secrets.QUAY_ROBOT_TOKEN }}
